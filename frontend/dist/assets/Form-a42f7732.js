import{d as se,n as ne,y as ue,u as de,r as E,p as N,a as _e,a1 as me,c as p,e as a,g as S,w as o,aA as ce,X as f,al as pe,o as m,aq as fe,b as g,i as y,q as I,F as z,s as O,ab as x,a7 as ge,ac as G,t as H,aB as ye,H as ve,aC as be,aD as qe,k as he,aj as Ve,ah as we,ai as Ee,a4 as xe,aE as ke,au as je,j as Ce,m as Re,av as Ue,aF as De,aw as Be,ak as Fe,E as Se,_ as Ie}from"./index-61294aba.js";/* empty css                *//* empty css                     *//* empty css                 *//* empty css                        */import"./el-tooltip-4ed993c7.js";/* empty css                     *//* empty css                 *//* empty css                        *//* empty css               *//* empty css                  *//* empty css                             *//* empty css               *//* empty css                  *//* empty css                       *//* empty css                 *//* empty css                       *//* empty css                   *//* empty css                      */import{P as Me}from"./ConfirmDialog.vue_vue_type_style_index_0_scoped_d3e333dd_lang-31e88244.js";/* empty css                  *//* empty css                          *//* empty css                  *//* empty css                         */import{u as Ye}from"./requisition-cf919b83.js";/* empty css                           *//* empty css                    */const Pe={class:"requisition-form"},Ae={class:"form-section"},Te={key:0,class:"urgent-details"},Ne={class:"form-section"},ze={class:"section-header"},Oe={key:0,class:"field-error"},Ge={key:0,class:"field-error"},He={key:0,class:"empty-items"},Ke={class:"form-actions"},Le=se({__name:"Form",setup(We){const M=ne(),k=ue(),v=Ye();de();const U=E(),b=E(!1),Y=E([]),K=E([{category_code:"office",category_name:"辦公用品"},{category_code:"electronic",category_name:"電子設備"},{category_code:"furniture",category_name:"辦公家具"},{category_code:"consumable",category_name:"耗材用品"},{category_code:"tool",category_name:"工具設備"},{category_code:"other",category_name:"其他"}]),q=N(()=>!!M.params.id),w=N(()=>M.params.id),t=_e({usage_type:"daily",items:[],is_urgent:!1,expected_delivery_date:"",urgent_reason:""}),j=E({}),L={usage_type:[{required:!0,message:"請選擇用途類型",trigger:"change"}],project_id:[{required:!0,message:"請選擇專案編號",trigger:"change",validator:(i,e,r)=>{t.usage_type==="project"&&!e?r(new Error("專案類型必須選擇專案編號")):r()}}],expected_delivery_date:[{required:!0,message:"請選擇期望到貨日期",trigger:"change",validator:(i,e,r)=>{t.is_urgent&&!e?r(new Error("加急請購單必須填寫期望到貨日期")):r()}}],urgent_reason:[{required:!0,message:"請說明加急原因",trigger:"blur",validator:(i,e,r)=>{t.is_urgent&&!(e!=null&&e.trim())?r(new Error("加急請購單必須說明加急原因")):r()}}]},h=(i,e)=>{var r;return(r=j.value[i])==null?void 0:r[e]},W=i=>{i||(t.expected_delivery_date="",t.urgent_reason="")},X=i=>i.getTime()<Date.now()-864e5,P=()=>{j.value={};let i=!1;return t.items.length===0?(f.error("請至少添加一個請購項目"),!1):(t.items.forEach((e,r)=>{var u;const s={};(u=e.item_name)!=null&&u.trim()||(s.item_name="項目名稱不能為空",i=!0),(!e.item_quantity||e.item_quantity<1)&&(s.item_quantity="數量必須大於0",i=!0),Object.keys(s).length>0&&(j.value[r]=s)}),i&&f.error("請檢查項目信息填寫"),!i)},C=()=>{t.items.push({item_name:"",item_quantity:1,item_unit:"個",item_specification:"",item_description:"",item_category:""})},J=i=>{t.items.splice(i,1),delete j.value[i]},A=()=>{k.go(-1)},Q=async()=>{var i;if(await((i=U.value)==null?void 0:i.validate())&&P())try{b.value=!0;const e={usage_type:t.usage_type,project_id:t.project_id,status:"draft",items:t.items.map(r=>{var s,u;return{item_name:r.item_name.trim(),item_quantity:r.item_quantity,item_unit:r.item_unit,item_specification:(s=r.item_specification)==null?void 0:s.trim(),item_description:(u=r.item_description)==null?void 0:u.trim(),item_category:r.item_category}}),is_urgent:t.is_urgent,expected_delivery_date:t.is_urgent?t.expected_delivery_date:void 0,urgent_reason:t.is_urgent?t.urgent_reason:void 0};q.value?(await v.updateRequisition(w.value,e),f.success("請購單保存成功")):(await v.createRequisition(e),f.success("請購單創建成功")),k.push("/requisitions")}catch(e){console.error("Save failed:",e)}finally{b.value=!1}},T=async()=>{var i;if(await((i=U.value)==null?void 0:i.validate())&&P())try{if(await ve.confirm("提交後將無法修改，確定要提交審核嗎？","提交確認",{confirmButtonText:"確定提交",cancelButtonText:"取消",type:"warning"})==="confirm"){if(b.value=!0,q.value){const r={usage_type:t.usage_type,project_id:t.project_id,status:"draft",items:t.items.map(s=>{var u,d;return{item_name:s.item_name.trim(),item_quantity:s.item_quantity,item_unit:s.item_unit,item_specification:(u=s.item_specification)==null?void 0:u.trim(),item_description:(d=s.item_description)==null?void 0:d.trim(),item_category:s.item_category}}),is_urgent:t.is_urgent,expected_delivery_date:t.is_urgent?t.expected_delivery_date:void 0,urgent_reason:t.is_urgent?t.urgent_reason:void 0};await v.updateRequisition(w.value,r),await v.submitRequisition(w.value)}else{const r={usage_type:t.usage_type,project_id:t.project_id,status:"submitted",items:t.items.map(s=>{var u,d;return{item_name:s.item_name.trim(),item_quantity:s.item_quantity,item_unit:s.item_unit,item_specification:(u=s.item_specification)==null?void 0:u.trim(),item_description:(d=s.item_description)==null?void 0:d.trim(),item_category:s.item_category}}),is_urgent:t.is_urgent,expected_delivery_date:t.is_urgent?t.expected_delivery_date:void 0,urgent_reason:t.is_urgent?t.urgent_reason:void 0};await v.createRequisition(r)}f.success("請購單已提交審核"),k.push("/requisitions")}}catch(e){e!=="cancel"&&console.error("Submit failed:",e)}finally{b.value=!1}},Z=async()=>{try{const i=await ce.getActiveProjects();Y.value=i}catch(i){console.error("Failed to fetch projects:",i)}},$=async()=>{if(q.value)try{const i=await v.fetchRequisitionDetail(w.value);t.usage_type=i.usage_type||"daily",t.project_id=i.project_id,t.is_urgent=i.is_urgent||!1,t.expected_delivery_date=i.expected_delivery_date||"",t.urgent_reason=i.urgent_reason||"",i.items&&i.items.length>0?t.items=i.items.map(e=>({item_name:e.item_name||"",item_quantity:e.item_quantity||1,item_unit:e.item_unit||"個",item_specification:e.item_specification||"",item_description:e.item_description||"",item_category:e.item_category||""})):C(),f.success("請購單數據載入完成")}catch{f.error("載入請購單失敗"),k.push("/requisitions")}};return me(async()=>{await Z(),q.value?await $():C()}),(i,e)=>{const r=be,s=qe,u=he,d=Ve,_=we,D=Ee,B=xe,ee=ke,te=je,R=Ce,V=Re,c=Ue,ae=De,ie=Be,oe=Fe,le=Se,re=pe;return m(),p("div",Pe,[a(S(Me),{title:q.value?"編輯請購單":"新增請購單",subtitle:q.value?`編輯 ${w.value}`:"創建新的請購申請","show-back":!0,onBack:A},null,8,["title","subtitle"]),a(re,null,{default:o(()=>[a(le,{ref_key:"formRef",ref:U,model:t,rules:L,"label-width":"120px",onSubmit:fe(T,["prevent"])},{default:o(()=>[g("div",Ae,[e[8]||(e[8]=g("h3",{class:"section-title"},"基本信息",-1)),a(B,{gutter:20},{default:o(()=>[a(d,{span:12},{default:o(()=>[a(u,{label:"用途類型",prop:"usage_type",required:""},{default:o(()=>[a(s,{modelValue:t.usage_type,"onUpdate:modelValue":e[0]||(e[0]=l=>t.usage_type=l)},{default:o(()=>[a(r,{label:"daily"},{default:o(()=>[...e[5]||(e[5]=[y("日常用品",-1)])]),_:1}),a(r,{label:"project"},{default:o(()=>[...e[6]||(e[6]=[y("專案用品",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1}),a(d,{span:12},{default:o(()=>[t.usage_type==="project"?(m(),I(u,{key:0,label:"專案編號",prop:"project_id",required:""},{default:o(()=>[a(D,{modelValue:t.project_id,"onUpdate:modelValue":e[1]||(e[1]=l=>t.project_id=l),placeholder:"選擇專案",filterable:"",clearable:"",style:{width:"100%"}},{default:o(()=>[(m(!0),p(z,null,O(Y.value,l=>(m(),I(_,{key:l.project_id,label:`${l.project_id} - ${l.project_name}`,value:l.project_id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})):x("",!0)]),_:1})]),_:1}),a(B,{gutter:20},{default:o(()=>[a(d,{span:24},{default:o(()=>[a(u,{label:"加急設定"},{default:o(()=>[a(ee,{modelValue:t.is_urgent,"onUpdate:modelValue":e[2]||(e[2]=l=>t.is_urgent=l),onChange:W,class:"urgent-checkbox"},{default:o(()=>[...e[7]||(e[7]=[g("span",{class:"urgent-label"},"此為加急請購單",-1)])]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}),t.is_urgent?(m(),p("div",Te,[a(B,{gutter:20},{default:o(()=>[a(d,{span:12},{default:o(()=>[a(u,{label:"期望到貨日期",prop:"expected_delivery_date",required:""},{default:o(()=>[a(te,{modelValue:t.expected_delivery_date,"onUpdate:modelValue":e[3]||(e[3]=l=>t.expected_delivery_date=l),type:"date",placeholder:"選擇期望到貨日期",format:"YYYY/MM/DD","value-format":"YYYY-MM-DD",style:{width:"100%"},"disabled-date":X,class:"urgent-date-picker"},null,8,["modelValue"])]),_:1})]),_:1}),a(d,{span:12},{default:o(()=>[a(u,{label:"加急原因",prop:"urgent_reason",required:""},{default:o(()=>[a(R,{modelValue:t.urgent_reason,"onUpdate:modelValue":e[4]||(e[4]=l=>t.urgent_reason=l),type:"textarea",rows:3,placeholder:"請詳細說明加急原因",maxlength:"200","show-word-limit":"",class:"urgent-reason-input"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})])):x("",!0)]),g("div",Ne,[g("div",ze,[e[10]||(e[10]=g("h3",{class:"section-title"},"請購項目",-1)),a(V,{type:"primary",icon:S(ge),onClick:C},{default:o(()=>[...e[9]||(e[9]=[y(" 新增項目 ",-1)])]),_:1},8,["icon"])]),a(ie,{data:t.items,border:"",style:{width:"100%"}},{default:o(()=>[a(c,{type:"index",label:"序號",width:"60",align:"center"}),a(c,{label:"項目名稱","min-width":"150"},{default:o(({row:l,$index:n})=>[a(R,{modelValue:l.item_name,"onUpdate:modelValue":F=>l.item_name=F,placeholder:"請輸入項目名稱",class:G({"is-error":h(n,"item_name")})},null,8,["modelValue","onUpdate:modelValue","class"]),h(n,"item_name")?(m(),p("div",Oe,H(h(n,"item_name")),1)):x("",!0)]),_:1}),a(c,{label:"規格說明","min-width":"150"},{default:o(({row:l})=>[a(R,{modelValue:l.item_specification,"onUpdate:modelValue":n=>l.item_specification=n,placeholder:"請輸入規格說明",type:"textarea",rows:2},null,8,["modelValue","onUpdate:modelValue"])]),_:1}),a(c,{label:"數量",width:"120"},{default:o(({row:l,$index:n})=>[a(ae,{modelValue:l.item_quantity,"onUpdate:modelValue":F=>l.item_quantity=F,min:1,precision:0,"controls-position":"right",style:{width:"100%"},class:G({"is-error":h(n,"item_quantity")})},null,8,["modelValue","onUpdate:modelValue","class"]),h(n,"item_quantity")?(m(),p("div",Ge,H(h(n,"item_quantity")),1)):x("",!0)]),_:1}),a(c,{label:"單位",width:"100"},{default:o(({row:l})=>[a(D,{modelValue:l.item_unit,"onUpdate:modelValue":n=>l.item_unit=n,placeholder:"選擇單位",style:{width:"100%"}},{default:o(()=>[a(_,{label:"個",value:"個"}),a(_,{label:"箱",value:"箱"}),a(_,{label:"包",value:"包"}),a(_,{label:"套",value:"套"}),a(_,{label:"張",value:"張"}),a(_,{label:"公斤",value:"公斤"}),a(_,{label:"公尺",value:"公尺"}),a(_,{label:"瓶",value:"瓶"})]),_:1},8,["modelValue","onUpdate:modelValue"])]),_:1}),a(c,{label:"類別",width:"120"},{default:o(({row:l})=>[a(D,{modelValue:l.item_category,"onUpdate:modelValue":n=>l.item_category=n,placeholder:"選擇類別",filterable:"",style:{width:"100%"}},{default:o(()=>[(m(!0),p(z,null,O(K.value,n=>(m(),I(_,{key:n.category_code,label:n.category_name,value:n.category_code},null,8,["label","value"]))),128))]),_:1},8,["modelValue","onUpdate:modelValue"])]),_:1}),a(c,{label:"用途說明","min-width":"150"},{default:o(({row:l})=>[a(R,{modelValue:l.item_description,"onUpdate:modelValue":n=>l.item_description=n,placeholder:"請說明用途",type:"textarea",rows:2},null,8,["modelValue","onUpdate:modelValue"])]),_:1}),a(c,{label:"操作",width:"80",fixed:"right"},{default:o(({$index:l})=>[a(V,{type:"danger",icon:S(ye),size:"small",onClick:n=>J(l)},null,8,["icon","onClick"])]),_:1})]),_:1},8,["data"]),t.items.length===0?(m(),p("div",He,[a(oe,{description:"請添加請購項目","image-size":60},{default:o(()=>[a(V,{type:"primary",onClick:C},{default:o(()=>[...e[11]||(e[11]=[y("添加第一個項目",-1)])]),_:1})]),_:1})])):x("",!0)]),g("div",Ke,[a(V,{onClick:A},{default:o(()=>[...e[12]||(e[12]=[y("取消",-1)])]),_:1}),a(V,{type:"info",loading:b.value,onClick:Q},{default:o(()=>[...e[13]||(e[13]=[y(" 保存草稿 ",-1)])]),_:1},8,["loading"]),a(V,{type:"primary",loading:b.value,onClick:T},{default:o(()=>[...e[14]||(e[14]=[y(" 提交審核 ",-1)])]),_:1},8,["loading"])])]),_:1},8,["model"])]),_:1})])}}});const Vt=Ie(Le,[["__scopeId","data-v-004ab5ff"],["__file","D:/AWORKSPACE/Github/project_ERP_dev_agent/frontend/src/views/requisitions/Form.vue"]]);export{Vt as default};
//# sourceMappingURL=Form-a42f7732.js.map
