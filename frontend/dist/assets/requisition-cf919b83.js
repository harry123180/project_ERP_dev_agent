import{U as C,r as _,p as R,az as l,W as f,X as v}from"./index-61294aba.js";const z=C("requisition",()=>{const u=_([]),i=_(null),n=_(!1),g=_({page:1,page_size:20,total:0,pages:0}),p=_({can_view_all:!1,user_role:"",filtered_to_own:!0}),d=_({mine:void 0,status:"",page:1,page_size:20}),y=R(()=>u.value.filter(e=>e.order_status==="submitted")),m=R(()=>u.value.filter(e=>e.requester_id===0)),w=R(()=>e=>u.value.find(t=>t.request_order_no===e)),I=async e=>{try{n.value=!0,e&&(d.value={...d.value,...e});const t=await l.getRequisitions(d.value);u.value=t.items,g.value=t.pagination,t.permissions&&(p.value=t.permissions)}catch(t){f(t,"獲取請購單列表失敗")}finally{n.value=!1}},$=async e=>{try{n.value=!0;const t=await l.getRequisition(e);return i.value=t,t}catch(t){throw f(t,"獲取請購單詳情失敗"),t}finally{n.value=!1}},S=async e=>{try{n.value=!0;const t=await l.createRequisition(e);return u.value.unshift(t),v.success("請購單創建成功"),t}catch(t){throw f(t,"創建請購單失敗"),t}finally{n.value=!1}},T=async(e,t)=>{var r;try{n.value=!0;const s=await l.updateRequisition(e,t),o=u.value.findIndex(a=>a.request_order_no===e);return o!==-1&&(u.value[o]=s),((r=i.value)==null?void 0:r.request_order_no)===e&&(i.value=s),v.success("請購單更新成功"),s}catch(s){throw f(s,"更新請購單失敗"),s}finally{n.value=!1}},E=async e=>{var t;try{n.value=!0;const r=await l.submitRequisition(e),s=u.value.findIndex(o=>o.request_order_no===e);return s!==-1&&(u.value[s]=r),((t=i.value)==null?void 0:t.request_order_no)===e&&(i.value=r),v.success("請購單提交成功"),r}catch(r){throw f(r,"提交請購單失敗"),r}finally{n.value=!1}},O=async(e,t,r)=>{try{n.value=!0;const s=await l.approveItem(e,t,r);return await h(e,3),v.success("項目審核通過"),s}catch(s){throw f(s,"審核項目失敗"),s}finally{n.value=!1}},X=async(e,t,r)=>{try{n.value=!0;const s=await l.questionItem(e,t,r);return await h(e,3),v.success("項目標記為有疑問"),s}catch(s){throw f(s,"標記項目疑問失敗"),s}finally{n.value=!1}},F=async(e,t,r)=>{try{n.value=!0;const s=await l.rejectItem(e,t,r);return await h(e,3),v.success("項目已駁回"),s}catch(s){throw f(s,"駁回項目失敗"),s}finally{n.value=!1}},x=async(e,t)=>{var r;try{n.value=!0;const s=await l.rejectRequisition(e,t),o=u.value.findIndex(a=>a.request_order_no===e);return o!==-1&&(u.value[o]=s),((r=i.value)==null?void 0:r.request_order_no)===e&&(i.value=s),v.success("請購單已駁回"),s}catch(s){throw f(s,"駁回請購單失敗"),s}finally{n.value=!1}},h=async(e,t=3)=>{var r;console.log(`[STORE_FIX] Refreshing requisition ${e} with retry logic`);for(let s=1;s<=t;s++)try{console.log(`[STORE_FIX] Refresh attempt ${s}/${t}`),s>1&&await new Promise(c=>setTimeout(c,1e3*s));const o=await l.getRequisition(e);((r=i.value)==null?void 0:r.request_order_no)===e&&(console.log(`[STORE_FIX] Updating current requisition status: ${i.value.order_status} -> ${o.order_status}`),i.value=o);const a=u.value.findIndex(c=>c.request_order_no===e);return a!==-1&&(console.log(`[STORE_FIX] Updating requisition in list status: ${u.value[a].order_status} -> ${o.order_status}`),u.value[a]=o),console.log(`[STORE_FIX] Successfully refreshed requisition on attempt ${s}`),o}catch(o){if(console.error(`[STORE_FIX] Refresh attempt ${s} failed:`,o),s===t)throw o}};return{requisitions:u,currentRequisition:i,loading:n,pagination:g,permissions:p,filters:d,pendingRequisitions:y,myRequisitions:m,requisitionById:w,fetchRequisitions:I,fetchRequisitionDetail:$,createRequisition:S,updateRequisition:T,submitRequisition:E,approveItem:O,questionItem:X,rejectItem:F,rejectRequisition:x,clearCurrentRequisition:()=>{i.value=null},refreshRequisitionWithRetry:h,pollRequisitionStatus:async(e,t,r=5)=>{var s;console.log(`[STORE_FIX] Polling for status change to '${t}' for requisition ${e}`);for(let o=1;o<=r;o++)try{const a=await l.getRequisition(e);if(console.log(`[STORE_FIX] Poll attempt ${o}: current status '${a.order_status}'`),a.order_status===t){console.log("[STORE_FIX] Status change detected! Updating store."),((s=i.value)==null?void 0:s.request_order_no)===e&&(i.value=a);const c=u.value.findIndex(q=>q.request_order_no===e);return c!==-1&&(u.value[c]=a),a}o<r&&await new Promise(c=>setTimeout(c,1e3))}catch(a){console.error(`[STORE_FIX] Poll attempt ${o} failed:`,a)}return console.log(`[STORE_FIX] Polling completed without status change to '${t}'`),null},saveItemChanges:async(e,t,r)=>{var s,o;try{console.log(`[STORE_HOTFIX] Saving changes for ${e}/${t}:`,r);const a=await l.saveItemChanges(e,t,r);if(((s=i.value)==null?void 0:s.request_order_no)===e){const c=(o=i.value.items)==null?void 0:o.findIndex(q=>q.detail_id===t);c!==-1&&i.value.items&&(i.value.items[c]=a)}return console.log(`[STORE_HOTFIX] Changes saved successfully for ${e}/${t}`),a}catch(a){throw f(a,"保存變更失敗"),a}}}});export{z as u};
//# sourceMappingURL=requisition-cf919b83.js.map
