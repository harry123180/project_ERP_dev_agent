import{d as se,r as z,z as ae,o as i,c as h,e as n,w as r,F as E,s as V,q as c,ab as y,g as S,a9 as pe,i as g,ap as le,aq as de,b as j,ar as I,as as ce,t as T,at as me,j as fe,ah as he,ai as ye,au as ge,k as _e,I as be,m as ie,E as ve,av as we,ao as qe,aw as Se,ax as Ce,a7 as ne,ay as ke,C as Re,_ as ue,y as ze,u as xe,p as B,a1 as De,X as q,H as re,az as oe,T as Ee}from"./index-61294aba.js";/* empty css                  *//* empty css                   *//* empty css                  *//* empty css                      *//* empty css               *//* empty css                  *//* empty css                     *//* empty css                 *//* empty css                        */import"./el-tooltip-4ed993c7.js";/* empty css                     *//* empty css                             */import{a as Ve,b as Te}from"./StatusTag-84a15be2.js";import{P as Be}from"./ConfirmDialog.vue_vue_type_style_index_0_scoped_d3e333dd_lang-31e88244.js";/* empty css               *//* empty css                       *//* empty css                 *//* empty css                          *//* empty css                  *//* empty css                        *//* empty css                *//* empty css                         */import{R as Fe}from"./Review-1a7e7b04.js";import{u as Ae}from"./requisition-cf919b83.js";/* empty css                       *//* empty css                           *//* empty css                    *//* empty css                        *//* empty css                         *//* empty css                 */const Pe={class:"data-table"},Me={key:0,class:"filter-bar"},Ye={key:1,class:"table-toolbar"},$e={class:"toolbar-left"},Ue={class:"toolbar-right"},je={class:"money"},Ie={key:2,class:"table-pagination"},Le={class:"pagination-total"},Ne=se({__name:"DataTable",props:{data:{type:Array,required:!1,default:()=>[]},loading:{type:Boolean,required:!1,default:!1},columns:{type:Array,required:!0},actions:{type:Array,required:!1},showFilterBar:{type:Boolean,required:!1,default:!0},filterFields:{type:Array,required:!1,default:()=>[]},showToolbar:{type:Boolean,required:!1,default:!0},showCreate:{type:Boolean,required:!1,default:!0},showExport:{type:Boolean,required:!1,default:!1},showSelection:{type:Boolean,required:!1,default:!1},showIndex:{type:Boolean,required:!1,default:!1},showSummary:{type:Boolean,required:!1,default:!1},summaryMethod:{type:Function,required:!1},tableHeight:{type:[String,Number],required:!1},maxHeight:{type:[String,Number],required:!1},showPagination:{type:Boolean,required:!1,default:!0},total:{type:Number,required:!1,default:0},pageSize:{type:Number,required:!1,default:20},pageSizes:{type:Array,required:!1,default:()=>[10,20,50,100]},paginationLayout:{type:String,required:!1,default:"total, sizes, prev, pager, next, jumper"},initialFilters:{type:Object,required:!1,default:()=>({})}},emits:["search","reset","refresh","create","export","selection-change","sort-change","page-change","size-change"],setup(te,{expose:x,emit:C}){const p=te,f=C,u=z({...p.initialFilters}),m=z(1),_=z(p.pageSize),k=()=>{m.value=1,f("search",{...u.value})},D=()=>{u.value={...p.initialFilters},m.value=1,f("reset")},F=()=>{f("refresh")},L=a=>{f("selection-change",a)},N=a=>{f("sort-change",a)},W=a=>{m.value=a,f("page-change",a)},A=a=>{_.value=a,m.value=1,f("size-change",a)},H=a=>Ve[a]||a,O=a=>Te[a]||"",G=a=>{var o;return((o=p.actions)==null?void 0:o.filter(b=>!b.visible||b.visible(a)))||[]},P=(a,o)=>a.disabled?a.disabled(o):!1,K=a=>typeof a!="number"?a:new Intl.NumberFormat("zh-TW",{style:"currency",currency:"TWD",minimumFractionDigits:0}).format(a),X=a=>a?new Date(a).toLocaleDateString("zh-TW"):"",J=({row:a,column:o,columnIndex:b})=>{const d=p.columns[b-(p.showSelection?1:0)-(p.showIndex?1:0)];return d&&d.cellClass?typeof d.cellClass=="function"?d.cellClass(a):d.cellClass:""};return ae(()=>p.pageSize,a=>{_.value=a}),ae(u,()=>{p.showFilterBar&&k()},{deep:!0}),x({search:k,reset:D,refresh:F,getCurrentFilters:()=>u.value,getCurrentPage:()=>m.value,getPageSize:()=>_.value}),(a,o)=>{const b=fe,d=he,M=ye,Y=ge,$=_e,v=be,w=ie,Q=ve,e=we,l=qe,Z=Se,ee=Ce;return i(),h("div",Pe,[a.showFilterBar?(i(),h("div",Me,[n(Q,{model:u.value,inline:!0,onSubmit:de(k,["prevent"])},{default:r(()=>[(i(!0),h(E,null,V(a.filterFields,t=>(i(),c($,{key:t.prop,label:t.label},{default:r(()=>[t.type==="input"?(i(),c(b,{key:0,modelValue:u.value[t.prop],"onUpdate:modelValue":s=>u.value[t.prop]=s,placeholder:t.placeholder,clearable:t.clearable!==!1,style:{width:"200px"}},null,8,["modelValue","onUpdate:modelValue","placeholder","clearable"])):t.type==="select"?(i(),c(M,{key:1,modelValue:u.value[t.prop],"onUpdate:modelValue":s=>u.value[t.prop]=s,placeholder:t.placeholder,clearable:t.clearable!==!1,filterable:t.filterable,multiple:t.multiple,style:{width:"200px"}},{default:r(()=>[(i(!0),h(E,null,V(t.options,s=>(i(),c(d,{key:s.value,label:s.label,value:s.value,disabled:s.disabled},null,8,["label","value","disabled"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue","placeholder","clearable","filterable","multiple"])):t.type==="date"?(i(),c(Y,{key:2,modelValue:u.value[t.prop],"onUpdate:modelValue":s=>u.value[t.prop]=s,type:"date",placeholder:t.placeholder,format:t.format||"YYYY-MM-DD","value-format":t.valueFormat||"YYYY-MM-DD",style:{width:"200px"}},null,8,["modelValue","onUpdate:modelValue","placeholder","format","value-format"])):t.type==="daterange"?(i(),c(Y,{key:3,modelValue:u.value[t.prop],"onUpdate:modelValue":s=>u.value[t.prop]=s,type:"daterange","range-separator":"至","start-placeholder":"開始日期","end-placeholder":"結束日期",format:t.format||"YYYY-MM-DD","value-format":t.valueFormat||"YYYY-MM-DD",style:{width:"250px"}},null,8,["modelValue","onUpdate:modelValue","format","value-format"])):y("",!0)]),_:2},1032,["label"]))),128)),n($,null,{default:r(()=>[n(w,{type:"primary",onClick:k},{default:r(()=>[n(v,null,{default:r(()=>[n(S(pe))]),_:1}),o[4]||(o[4]=g(" 搜索 ",-1))]),_:1}),n(w,{onClick:D},{default:r(()=>[n(v,null,{default:r(()=>[n(S(le))]),_:1}),o[5]||(o[5]=g(" 重置 ",-1))]),_:1})]),_:1})]),_:1},8,["model"])])):y("",!0),a.showToolbar?(i(),h("div",Ye,[j("div",$e,[I(a.$slots,"toolbar-left",{},()=>[a.showCreate?(i(),c(w,{key:0,type:"primary",onClick:o[0]||(o[0]=t=>a.$emit("create"))},{default:r(()=>[n(v,null,{default:r(()=>[n(S(ne))]),_:1}),o[6]||(o[6]=g(" 新增 ",-1))]),_:1})):y("",!0)],!0)]),j("div",Ue,[I(a.$slots,"toolbar-right",{},()=>[a.showExport?(i(),c(w,{key:0,onClick:o[1]||(o[1]=t=>a.$emit("export"))},{default:r(()=>[n(v,null,{default:r(()=>[n(S(ke))]),_:1}),o[7]||(o[7]=g(" 導出 ",-1))]),_:1})):y("",!0),n(w,{onClick:F},{default:r(()=>[n(v,null,{default:r(()=>[n(S(le))]),_:1}),o[8]||(o[8]=g(" 刷新 ",-1))]),_:1})],!0)])])):y("",!0),n(Z,me({data:a.data,loading:a.loading,stripe:"",border:"",height:a.tableHeight,"max-height":a.maxHeight,"show-summary":a.showSummary,"summary-method":a.summaryMethod,"cell-class-name":J,onSelectionChange:L,onSortChange:N},a.$attrs),{default:r(()=>[a.showSelection?(i(),c(e,{key:0,type:"selection",width:"55",align:"center",fixed:"left"})):y("",!0),a.showIndex?(i(),c(e,{key:1,type:"index",label:"序號",width:"60",align:"center",fixed:"left"})):y("",!0),(i(!0),h(E,null,V(a.columns,t=>(i(),c(e,{key:t.prop||t.type,prop:t.prop,label:t.label,width:t.width,"min-width":t.minWidth,fixed:t.fixed,sortable:t.sortable,align:t.align||"left","header-align":t.headerAlign||t.align||"center","show-overflow-tooltip":t.showOverflowTooltip!==!1,resizable:t.resizable!==!1,formatter:t.formatter},ce({_:2},[t.type==="status"?{name:"default",fn:r(({row:s})=>[n(l,{type:O(s[t.prop]),size:"small"},{default:r(()=>[g(T(H(s[t.prop])),1)]),_:2},1032,["type"])]),key:"0"}:t.type==="money"?{name:"default",fn:r(({row:s})=>[j("span",je,T(K(s[t.prop])),1)]),key:"1"}:t.type==="date"?{name:"default",fn:r(({row:s})=>[g(T(X(s[t.prop])),1)]),key:"2"}:t.type==="actions"?{name:"default",fn:r(({row:s,$index:U})=>[I(a.$slots,"actions",{row:s,index:U},()=>[(i(!0),h(E,null,V(G(s),R=>(i(),c(w,{key:R.label,type:R.type||"primary",disabled:P(R,s),size:"small",link:"",onClick:Ge=>R.handler(s,U)},{default:r(()=>[R.icon?(i(),c(v,{key:0},{default:r(()=>[(i(),c(Re(R.icon)))]),_:2},1024)):y("",!0),g(" "+T(R.label),1)]),_:2},1032,["type","disabled","onClick"]))),128))],!0)]),key:"3"}:a.$slots[`column-${t.prop}`]?{name:"default",fn:r(({row:s,$index:U})=>[I(a.$slots,`column-${t.prop}`,{row:s,index:U},void 0,!0)]),key:"4"}:void 0]),1032,["prop","label","width","min-width","fixed","sortable","align","header-align","show-overflow-tooltip","resizable","formatter"]))),128))]),_:3},16,["data","loading","height","max-height","show-summary","summary-method"]),a.showPagination?(i(),h("div",Ie,[n(ee,{"current-page":m.value,"onUpdate:currentPage":o[2]||(o[2]=t=>m.value=t),"page-size":_.value,"onUpdate:pageSize":o[3]||(o[3]=t=>_.value=t),total:a.total,"page-sizes":a.pageSizes,layout:a.paginationLayout,"prev-text":"上一頁","next-text":"下一頁",background:"",onSizeChange:A,onCurrentChange:W},{sizes:r(()=>[n(M,{"model-value":_.value,"onUpdate:modelValue":A,style:{width:"100px"},size:"small"},{default:r(()=>[(i(!0),h(E,null,V(a.pageSizes,t=>(i(),c(d,{key:t,label:`${t}筆/頁`,value:t},null,8,["label","value"]))),128))]),_:1},8,["model-value"])]),total:r(()=>[j("span",Le,"共 "+T(a.total)+" 筆",1)]),_:1},8,["current-page","page-size","total","page-sizes","layout"])])):y("",!0)])}}}),We=ue(Ne,[["__scopeId","data-v-046d4556"],["__file","D:/AWORKSPACE/Github/project_ERP_dev_agent/frontend/src/components/DataTable.vue"]]),He={class:"requisition-list"},Oe=se({__name:"List",setup(te){const x=ze(),C=Ae(),p=xe();B(()=>p.userRole);const f=z(!1),u=z(!1),m=z(null),_=B(()=>C.requisitions),k=B(()=>C.pagination),D=B(()=>C.permissions),F=[{prop:"request_order_no",label:"請購單號",width:"160px",fixed:"left"},{prop:"is_urgent",label:"加急",width:"70px",align:"center",formatter:e=>e.is_urgent?"加急":"",cellClass:e=>e.is_urgent?"urgent-cell":""},{prop:"requester_name",label:"申請人",width:"120px"},{prop:"usage_type",label:"用途類型",width:"100px",formatter:e=>e.usage_type==="daily"?"日常":"專案"},{prop:"project_id",label:"專案編號",width:"120px",showOverflowTooltip:!0},{prop:"submit_date",label:"提交日期",width:"120px",type:"date"},{prop:"order_status",label:"狀態",width:"100px",type:"status"},{prop:"summary.total_items",label:"總項目數",width:"100px",align:"center"},{prop:"summary.approved_items",label:"已核准",width:"80px",align:"center",formatter:e=>{var l;return((l=e.summary)==null?void 0:l.approved_items)||0}},{prop:"summary.rejected_items",label:"已駁回",width:"80px",align:"center",formatter:e=>{var l;return((l=e.summary)==null?void 0:l.rejected_items)||0},cellClass:e=>{var l;return(((l=e.summary)==null?void 0:l.rejected_items)||0)>0?"rejected-cell":""}},{prop:"summary.questioned_items",label:"有疑問",width:"80px",align:"center",formatter:e=>{var l;return((l=e.summary)==null?void 0:l.questioned_items)||0},cellClass:e=>{var l;return(((l=e.summary)==null?void 0:l.questioned_items)||0)>0?"questioned-cell":""}},{prop:"created_at",label:"創建時間",width:"160px",type:"date"},{type:"actions",label:"操作",width:"200px",fixed:"right"}],L=[{label:"查看",type:"primary",icon:"View",handler:e=>Y(e.request_order_no)},{label:"編輯",type:"primary",icon:"Edit",handler:e=>$(e.request_order_no),visible:e=>e.order_status==="draft"&&W(e)},{label:"審核",type:"warning",icon:"DocumentChecked",handler:e=>v(e),visible:e=>e.order_status==="submitted"&&O()},{label:"刪除",type:"danger",icon:"Delete",handler:e=>w(e.request_order_no),visible:e=>e.order_status==="draft"&&A(e)},{label:"撤銷",type:"danger",icon:"Delete",handler:e=>Q(e.request_order_no),visible:e=>e.order_status==="submitted"&&H()}],N=B(()=>[...D.value.can_view_all?[{prop:"mine",label:"範圍",type:"select",options:[{label:"我的請購單",value:!0},{label:"所有請購單",value:!1}],clearable:!1}]:[],{prop:"status",label:"狀態",type:"select",options:[{label:"草稿",value:"draft"},{label:"已提交",value:"submitted"},{label:"已審核",value:"reviewed"},{label:"已撤銷",value:"cancelled"}]},{prop:"usage_type",label:"用途類型",type:"select",options:[{label:"日常",value:"daily"},{label:"專案",value:"project"}]},{prop:"project_id",label:"專案編號",type:"input",placeholder:"請輸入專案編號"},{prop:"submit_date_range",label:"提交日期",type:"daterange"}]),W=e=>{var l;return p.hasRole("Admin")||((l=p.user)==null?void 0:l.user_id)===e.requester_id},A=e=>{var l;return p.hasRole("Admin")||((l=p.user)==null?void 0:l.user_id)===e.requester_id},H=e=>p.hasRole("ProcurementMgr","Admin"),O=()=>p.hasRole("Admin","ProcurementMgr","Procurement"),G=e=>e.row.is_urgent?"urgent-row":"",P=()=>D.value.can_view_all?{mine:!1}:{},K=e=>{d(e)},X=()=>{d()},J=e=>{d({page:e})},a=e=>{d({page:1,page_size:e})},o=()=>{u.value=!1,m.value=null},b=()=>{o(),d(),q.success("請購單審核完成")},d=async e=>{try{f.value=!0,await C.fetchRequisitions(e)}catch(l){console.error("Failed to fetch requisitions:",l)}finally{f.value=!1}},M=()=>{x.push("/requisitions/create")},Y=e=>{x.push(`/requisitions/${e}`)},$=e=>{x.push(`/requisitions/${e}/edit`)},v=async e=>{try{const l=await C.fetchRequisitionDetail(e.request_order_no);m.value=l,u.value=!0}catch{q.error("獲取請購單詳情失敗")}},w=async e=>{try{await re.confirm("確定要刪除這個請購單嗎？","刪除確認",{confirmButtonText:"刪除",cancelButtonText:"取消",type:"warning"});const l=await oe.cancelRequisition(e,{reason:"管理員刪除草稿請購單"});l.success?(q.success("請購單已刪除"),d()):q.error(l.message||"刪除失敗")}catch(l){l!=="cancel"&&(console.error("刪除請購單失敗:",l),q.error("刪除失敗"))}},Q=async e=>{try{await re.confirm("是否確定要撤銷該張請購單？","確認撤銷",{confirmButtonText:"確定",cancelButtonText:"取消",type:"warning"});const l=await oe.cancelRequisition(e,{reason:"管理員撤銷請購單"});l.success?(q.success("請購單已撤銷"),d()):q.error(l.message||"撤銷失敗")}catch(l){l!=="cancel"&&(console.error("撤銷請購單失敗:",l),q.error("撤銷請購單失敗"))}};return De(()=>{const e=P();d(e)}),(e,l)=>{const Z=ie,ee=Ee;return i(),h("div",He,[n(S(Be),{title:"請購單列表",subtitle:"管理所有請購申請","show-refresh":!0,onRefresh:X},{extra:r(()=>[n(Z,{type:"primary",icon:S(ne),onClick:M},{default:r(()=>[...l[1]||(l[1]=[g(" 新增請購單 ",-1)])]),_:1},8,["icon"])]),_:1}),n(S(We),{data:_.value,columns:F,actions:L,loading:f.value,"show-pagination":!0,total:k.value.total,"page-size":k.value.page_size,"filter-fields":N.value,"initial-filters":P(),"row-class-name":G,onSearch:K,onPageChange:J,onSizeChange:a},null,8,["data","loading","total","page-size","filter-fields","initial-filters"]),n(ee,{modelValue:u.value,"onUpdate:modelValue":l[0]||(l[0]=t=>u.value=t),title:"審核請購單",width:"95vw",style:{"max-width":"1400px"},"destroy-on-close":""},{default:r(()=>[m.value?(i(),c(Fe,{key:0,requisition:m.value,onClose:o,onUpdated:b},null,8,["requisition"])):y("",!0)]),_:1},8,["modelValue"])])}}});const Rt=ue(Oe,[["__scopeId","data-v-b6f58583"],["__file","D:/AWORKSPACE/Github/project_ERP_dev_agent/frontend/src/views/requisitions/List.vue"]]);export{Rt as default};
//# sourceMappingURL=List-86dc11c2.js.map
