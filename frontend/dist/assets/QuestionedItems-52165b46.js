import{a3 as c,d as qe,y as he,r as d,a as O,a1 as Ee,c as I,b as C,e as l,w as a,ab as j,az as F,X as b,m as Se,a4 as ke,al as xe,T as De,o as v,i as r,f as Ie,g as $e,a9 as ze,aP as Re,q as T,t as u,F as W,s as Fe,H as Te,I as Ue,j as Pe,aj as Ae,au as Be,av as Ye,aQ as je,aR as Me,ao as Ne,aw as Qe,ax as Le,k as Ke,aC as Oe,aD as We,ah as Ge,ai as He,aF as Je,E as Xe,aJ as Ze,aK as et,aS as tt,_ as lt}from"./index-61294aba.js";/* empty css                   *//* empty css                             *//* empty css                  *//* empty css                   *//* empty css                     *//* empty css                 *//* empty css                        *//* empty css               *//* empty css                  *//* empty css                     *//* empty css                       *//* empty css                 *//* empty css                *//* empty css                      *//* empty css                        */import"./el-tooltip-4ed993c7.js";/* empty css                *//* empty css               *//* empty css                             *//* empty css                  *//* empty css                       */const ot={getSuppliers(s){return c.get("/suppliers",{params:s})},getSupplier(s){return c.get(`/suppliers/${s}`)},createSupplier(s){return c.post("/suppliers",s)},updateSupplier(s,g){return c.put(`/suppliers/${s}`,g)},deleteSupplier(s){return c.delete(`/suppliers/${s}`)},getSuppliersSummary(s){return c.get("/suppliers/summary",{params:s})},getSupplierPurchaseOrders(s,g){return c.get(`/suppliers/${s}/purchase-orders`,{params:g})},getSupplierStats(s){return c.get(`/suppliers/${s}/stats`)},exportSuppliers(s){return c.get("/suppliers/export",{params:s,responseType:"blob"})},importSuppliers(s){const g=new FormData;return g.append("file",s),c.post("/suppliers/import",g,{headers:{"Content-Type":"multipart/form-data"}})}},at={class:"questioned-items"},nt={class:"page-header"},rt={class:"header-actions"},st={class:"filter-section"},it={key:1,class:"text-muted"},ut={key:0,class:"batch-actions"},pt={class:"batch-header"},dt=qe({__name:"QuestionedItems",setup(s){const g=he(),h=d(!1),U=d(!1),M=d([]),E=d([]),p=d(null),P=d(0),q=d(1),$=d(20),z=d(""),S=d(null),f=d([]),k=d(!1),x=d(!1),N=d(),n=O({detail_id:0,request_order_no:"",item_name:"",original_note:"",resolution:"",action:"approve",supplier_id:"",unit_price:0}),G=O({resolution:[{required:!0,message:"請輸入解決方案",trigger:"blur"}],action:[{required:!0,message:"請選擇處理結果",trigger:"change"}],supplier_id:[{required:!0,message:"請選擇供應商",trigger:"change",validator:(o,t,i)=>{n.action==="approve"&&!t?i(new Error("核准時必須選擇供應商")):i()}}],unit_price:[{required:!0,message:"請輸入單價",trigger:"blur",validator:(o,t,i)=>{n.action==="approve"&&(!t||t<=0)?i(new Error("核准時必須輸入有效的單價")):i()}}]}),y=async()=>{h.value=!0;try{const o={page:q.value,page_size:$.value};z.value&&(o.search=z.value),S.value&&(o.start_date=S.value[0],o.end_date=S.value[1]);const t=await F.getQuestionedItems(o);M.value=t.items,P.value=t.total}catch(o){console.error("Failed to fetch questioned items:",o),b.error("獲取疑問項目失敗")}finally{h.value=!1}},R=()=>{q.value=1,y()},H=o=>{q.value=o,y()},J=o=>{$.value=o,q.value=1,y()},X=o=>{E.value=o},Z=o=>{g.push(`/requisitions/${o}`)},ee=o=>{p.value=o,x.value=!0},Q=o=>{p.value=o,n.detail_id=o.detail_id,n.request_order_no=o.request_order_no,n.item_name=o.item_name,n.original_note=o.status_note||"",n.resolution="",n.action="approve",n.supplier_id=o.supplier_id||"",n.unit_price=o.unit_price||.01,k.value=!0},te=o=>{o!=="approve"&&(n.supplier_id="",n.unit_price=0)},le=()=>{x.value=!1,p.value&&Q(p.value)},oe=async()=>{var o;if(await((o=N.value)==null?void 0:o.validate()))try{U.value=!0;const t={resolution:n.resolution};n.action==="approve"?(await F.approveItem(n.request_order_no,n.detail_id,{supplier_id:n.supplier_id,unit_price:n.unit_price,note:n.resolution}),b.success("項目已轉為已核准")):n.action==="reject"?(await F.rejectItem(n.request_order_no,n.detail_id,{reason:n.resolution}),b.success("項目已拒絕")):(await F.updateItemNote(n.request_order_no,n.detail_id,{note:`${n.original_note}
解決方案: ${n.resolution}`}),b.success("已更新項目備註")),k.value=!1,y()}catch(t){console.error("Failed to resolve item:",t),b.error("處理失敗")}finally{U.value=!1}},ae=async()=>{try{if(await Te.confirm(`確定要批量解決 ${E.value.length} 個疑問項目嗎？所有項目將轉為已核准狀態。`,"批量解決確認",{confirmButtonText:"確定",cancelButtonText:"取消",type:"warning"})==="confirm"){h.value=!0;let t=0,i=0;for(const A of E.value)try{b.warning("批量核准需要逐個設置供應商和單價，請使用單個解決功能");return}catch(w){i++,console.error(`Failed to resolve item ${A.detail_id}:`,w)}t>0&&b.success(`成功解決 ${t} 個項目`),i>0&&b.warning(`${i} 個項目處理失敗`),y()}}catch{}finally{h.value=!1}},ne=o=>o?new Date(o).toLocaleDateString("zh-TW"):"-",re=o=>o?new Date(o).toLocaleString("zh-TW"):"-",se=o=>({office:"辦公用品",electronic:"電子設備",furniture:"辦公家具",consumable:"耗材用品",tool:"工具設備",other:"其他"})[o||""]||o||"-",ie=async()=>{try{const o=await ot.getSuppliers({page_size:100});console.log("Supplier API response:",o),o&&o.data?(f.value=o.data.items||[],console.log("Suppliers set from response.data.items:",f.value)):o&&o.items?(f.value=o.items||[],console.log("Suppliers set from response.items:",f.value)):Array.isArray(o)?(f.value=o,console.log("Suppliers set from array response:",f.value)):(console.warn("Unexpected supplier API response structure:",o),f.value=[])}catch(o){console.error("Failed to fetch suppliers:",o),f.value=[]}};return Ee(()=>{y(),ie()}),(o,t)=>{const i=Se,A=Ue,w=Pe,B=Ae,ue=Be,pe=ke,_=Ye,de=je,_e=Me,me=Ne,ce=Qe,fe=Le,L=xe,V=Ke,Y=Oe,ve=We,ge=Ge,be=He,ye=Je,we=Xe,K=De,m=Ze,Ve=et,Ce=tt;return v(),I("div",at,[C("div",nt,[t[16]||(t[16]=C("h1",null,"管理疑問項目",-1)),C("div",rt,[l(i,{onClick:y,icon:"Refresh"},{default:a(()=>[...t[15]||(t[15]=[r("重新整理",-1)])]),_:1})])]),C("div",st,[l(pe,{gutter:20},{default:a(()=>[l(B,{span:6},{default:a(()=>[l(w,{modelValue:z.value,"onUpdate:modelValue":t[0]||(t[0]=e=>z.value=e),placeholder:"搜尋項目名稱或請購單號",clearable:"",onClear:R,onKeyup:Ie(R,["enter"])},{prefix:a(()=>[l(A,null,{default:a(()=>[l($e(ze))]),_:1})]),_:1},8,["modelValue"])]),_:1}),l(B,{span:6},{default:a(()=>[l(ue,{modelValue:S.value,"onUpdate:modelValue":t[1]||(t[1]=e=>S.value=e),type:"daterange","range-separator":"至","start-placeholder":"開始日期","end-placeholder":"結束日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",onChange:R},null,8,["modelValue"])]),_:1}),l(B,{span:4},{default:a(()=>[l(i,{type:"primary",onClick:R,icon:"Search"},{default:a(()=>[...t[17]||(t[17]=[r("搜尋",-1)])]),_:1})]),_:1})]),_:1})]),l(L,null,{default:a(()=>[Re((v(),T(ce,{data:M.value,border:"",stripe:"",style:{width:"100%"},onSelectionChange:X},{default:a(()=>[l(_,{type:"selection",width:"55"}),l(_,{label:"請購單號",prop:"request_order_no",width:"140",fixed:"left"},{default:a(({row:e})=>[l(de,{type:"primary",onClick:D=>Z(e.request_order_no)},{default:a(()=>[r(u(e.request_order_no),1)]),_:2},1032,["onClick"])]),_:1}),l(_,{label:"項目名稱",prop:"item_name","min-width":"150","show-overflow-tooltip":""}),l(_,{label:"規格",prop:"item_specification","min-width":"150","show-overflow-tooltip":""}),l(_,{label:"數量",width:"100"},{default:a(({row:e})=>[r(u(e.item_quantity)+" "+u(e.item_unit),1)]),_:1}),l(_,{label:"請購人",prop:"requester_name",width:"100"}),l(_,{label:"疑問原因",prop:"status_note","min-width":"200","show-overflow-tooltip":""},{default:a(({row:e})=>[e.status_note?(v(),T(_e,{key:0,content:e.status_note,placement:"top"},{default:a(()=>[C("span",null,u(e.status_note),1)]),_:2},1032,["content"])):(v(),I("span",it,"未提供原因"))]),_:1}),l(_,{label:"標記日期",prop:"questioned_at",width:"120"},{default:a(({row:e})=>[r(u(ne(e.questioned_at)),1)]),_:1}),l(_,{label:"標記人",prop:"questioned_by",width:"100"}),l(_,{label:"狀態",width:"100",align:"center"},{default:a(({row:e})=>[l(me,{type:"warning",size:"small"},{default:a(()=>[...t[18]||(t[18]=[r("有疑問",-1)])]),_:1})]),_:1}),l(_,{label:"操作",width:"200",fixed:"right"},{default:a(({row:e})=>[l(i,{type:"primary",size:"small",onClick:D=>Q(e)},{default:a(()=>[...t[19]||(t[19]=[r(" 解決疑問 ",-1)])]),_:1},8,["onClick"]),l(i,{size:"small",onClick:D=>ee(e)},{default:a(()=>[...t[20]||(t[20]=[r(" 查看詳情 ",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[Ce,h.value]]),P.value>0?(v(),T(fe,{key:0,"current-page":q.value,"onUpdate:currentPage":t[2]||(t[2]=e=>q.value=e),"page-size":$.value,"onUpdate:pageSize":t[3]||(t[3]=e=>$.value=e),"page-sizes":[10,20,50,100],total:P.value,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:J,onCurrentChange:H},null,8,["current-page","page-size","total"])):j("",!0)]),_:1}),E.value.length>0?(v(),I("div",ut,[l(L,null,{default:a(()=>[C("div",pt,[C("span",null,"已選擇 "+u(E.value.length)+" 個項目",1),l(i,{type:"primary",onClick:ae},{default:a(()=>[...t[21]||(t[21]=[r("批量解決疑問",-1)])]),_:1})])]),_:1})])):j("",!0),l(K,{modelValue:k.value,"onUpdate:modelValue":t[12]||(t[12]=e=>k.value=e),title:"解決疑問項目",width:"600px","close-on-click-modal":!1},{footer:a(()=>[l(i,{onClick:t[11]||(t[11]=e=>k.value=!1)},{default:a(()=>[...t[25]||(t[25]=[r("取消",-1)])]),_:1}),l(i,{type:"primary",onClick:oe,loading:U.value},{default:a(()=>[...t[26]||(t[26]=[r("確認",-1)])]),_:1},8,["loading"])]),default:a(()=>[l(we,{ref_key:"resolveFormRef",ref:N,model:n,rules:G,"label-width":"120px"},{default:a(()=>[l(V,{label:"請購單號"},{default:a(()=>[l(w,{modelValue:n.request_order_no,"onUpdate:modelValue":t[4]||(t[4]=e=>n.request_order_no=e),disabled:""},null,8,["modelValue"])]),_:1}),l(V,{label:"項目名稱"},{default:a(()=>[l(w,{modelValue:n.item_name,"onUpdate:modelValue":t[5]||(t[5]=e=>n.item_name=e),disabled:""},null,8,["modelValue"])]),_:1}),l(V,{label:"原疑問原因"},{default:a(()=>[l(w,{modelValue:n.original_note,"onUpdate:modelValue":t[6]||(t[6]=e=>n.original_note=e),type:"textarea",rows:2,disabled:""},null,8,["modelValue"])]),_:1}),l(V,{label:"解決方案",prop:"resolution"},{default:a(()=>[l(w,{modelValue:n.resolution,"onUpdate:modelValue":t[7]||(t[7]=e=>n.resolution=e),type:"textarea",rows:3,placeholder:"請說明如何解決此疑問"},null,8,["modelValue"])]),_:1}),l(V,{label:"處理結果",prop:"action"},{default:a(()=>[l(ve,{modelValue:n.action,"onUpdate:modelValue":t[8]||(t[8]=e=>n.action=e),onChange:te},{default:a(()=>[l(Y,{label:"approve"},{default:a(()=>[...t[22]||(t[22]=[r("轉為已核准",-1)])]),_:1}),l(Y,{label:"reject"},{default:a(()=>[...t[23]||(t[23]=[r("拒絕此項目",-1)])]),_:1}),l(Y,{label:"keep"},{default:a(()=>[...t[24]||(t[24]=[r("保持疑問狀態",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1}),n.action==="approve"?(v(),I(W,{key:0},[l(V,{label:"供應商",prop:"supplier_id"},{default:a(()=>[l(be,{modelValue:n.supplier_id,"onUpdate:modelValue":t[9]||(t[9]=e=>n.supplier_id=e),placeholder:"請選擇供應商",filterable:""},{default:a(()=>[(v(!0),I(W,null,Fe(f.value,e=>(v(),T(ge,{key:e.supplier_id,label:`${e.supplier_id} - ${e.supplier_name_zh||e.supplier_name}`,value:e.supplier_id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),l(V,{label:"單價",prop:"unit_price"},{default:a(()=>[l(ye,{modelValue:n.unit_price,"onUpdate:modelValue":t[10]||(t[10]=e=>n.unit_price=e),min:.01,precision:2,placeholder:"請輸入單價"},null,8,["modelValue"])]),_:1})],64)):j("",!0)]),_:1},8,["model","rules"])]),_:1},8,["modelValue"]),l(K,{modelValue:x.value,"onUpdate:modelValue":t[14]||(t[14]=e=>x.value=e),title:"疑問項目詳情",width:"700px"},{footer:a(()=>[l(i,{onClick:t[13]||(t[13]=e=>x.value=!1)},{default:a(()=>[...t[27]||(t[27]=[r("關閉",-1)])]),_:1}),l(i,{type:"primary",onClick:le},{default:a(()=>[...t[28]||(t[28]=[r("解決疑問",-1)])]),_:1})]),default:a(()=>[l(Ve,{column:2,border:""},{default:a(()=>[l(m,{label:"請購單號"},{default:a(()=>{var e;return[r(u((e=p.value)==null?void 0:e.request_order_no),1)]}),_:1}),l(m,{label:"請購人"},{default:a(()=>{var e;return[r(u((e=p.value)==null?void 0:e.requester_name),1)]}),_:1}),l(m,{label:"項目名稱",span:2},{default:a(()=>{var e;return[r(u((e=p.value)==null?void 0:e.item_name),1)]}),_:1}),l(m,{label:"規格說明",span:2},{default:a(()=>{var e;return[r(u(((e=p.value)==null?void 0:e.item_specification)||"無"),1)]}),_:1}),l(m,{label:"數量"},{default:a(()=>{var e,D;return[r(u((e=p.value)==null?void 0:e.item_quantity)+" "+u((D=p.value)==null?void 0:D.item_unit),1)]}),_:1}),l(m,{label:"類別"},{default:a(()=>{var e;return[r(u(se((e=p.value)==null?void 0:e.item_category)),1)]}),_:1}),l(m,{label:"用途說明",span:2},{default:a(()=>{var e;return[r(u(((e=p.value)==null?void 0:e.item_description)||"無"),1)]}),_:1}),l(m,{label:"疑問原因",span:2},{default:a(()=>{var e;return[r(u(((e=p.value)==null?void 0:e.status_note)||"未提供原因"),1)]}),_:1}),l(m,{label:"標記時間"},{default:a(()=>{var e;return[r(u(re((e=p.value)==null?void 0:e.questioned_at)),1)]}),_:1}),l(m,{label:"標記人"},{default:a(()=>{var e;return[r(u((e=p.value)==null?void 0:e.questioned_by),1)]}),_:1})]),_:1})]),_:1},8,["modelValue"])])}}});const Ft=lt(dt,[["__scopeId","data-v-8b7041f7"],["__file","D:/AWORKSPACE/Github/project_ERP_dev_agent/frontend/src/views/requisitions/QuestionedItems.vue"]]);export{Ft as default};
//# sourceMappingURL=QuestionedItems-52165b46.js.map
