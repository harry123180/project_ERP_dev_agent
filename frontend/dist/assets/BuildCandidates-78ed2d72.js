import{d as ce,y as pe,r as f,p as y,a1 as _e,c as m,e as a,g as B,w as i,b as t,V as U,X as b,H as me,m as ve,ak as he,ai as fe,aX as ye,al as be,o as c,aV as we,i as k,F as W,s as j,q as F,ac as H,ad as ge,ab as Q,t as r,aY as ke,I as Ce,ao as Ee,ah as xe,aE as Se,av as ze,aw as Ie,aL as Be,_ as Te}from"./index-61294aba.js";/* empty css                        */import"./el-tooltip-4ed993c7.js";/* empty css                     *//* empty css               *//* empty css                *//* empty css                          *//* empty css                  *//* empty css                 *//* empty css                  *//* empty css                         *//* empty css                       *//* empty css                 *//* empty css                   *//* empty css                      *//* empty css                     *//* empty css                             */import{P as Ve}from"./ConfirmDialog.vue_vue_type_style_index_0_scoped_d3e333dd_lang-31e88244.js";/* empty css                  *//* empty css               *//* empty css                       *//* empty css                 *//* empty css                  *//* empty css                        *//* empty css                           *//* empty css                    */const Ne={class:"build-candidates"},Ae={key:0,class:"loading-container"},Me={key:1,class:"empty-state"},Oe={key:2,class:"candidates-content"},Pe={class:"supplier-selector"},qe={class:"supplier-option"},Fe={class:"supplier-meta"},Le={key:0,class:"no-supplier-selected"},De={key:1,class:"po-builder"},Ge={class:"left-panel"},Re={class:"panel-header"},$e={class:"panel-actions"},Ue={class:"items-list"},We={class:"item-content"},je={class:"item-header"},He={class:"item-name"},Qe={class:"item-price"},Xe={class:"item-details"},Ke={class:"item-spec"},Ye={class:"item-qty"},Je={class:"item-meta"},Ze={class:"source-no"},et={class:"item-subtotal"},tt={class:"right-panel"},st={class:"panel-header"},lt={class:"panel-actions"},at={class:"po-preview"},nt={key:0,class:"preview-empty"},it={key:1,class:"preview-content"},ot={class:"supplier-details"},rt={class:"detail-row"},ut={class:"detail-row"},dt={class:"detail-row"},ct={class:"money"},pt={class:"money"},_t={class:"amount-details"},mt={class:"amount-row"},vt={class:"money"},ht={class:"amount-row"},ft={class:"money"},yt={class:"amount-row total"},bt={class:"money total-amount"},wt=ce({__name:"BuildCandidates",setup(gt){const L=pe(),T=f(!1),V=f(!1),x=f([]),n=f(null),S=f(null),p=f([]),X=f(!1),g=f(""),D=y(()=>x.value.filter(s=>s.supplier_id&&s.supplier_id!=="null"&&s.supplier_id!==null)),N=(s,e)=>{if(!e)return!0;const d=e.toLowerCase(),_=s.toLowerCase();if(_.includes(d))return!0;let o=0;for(let u=0;u<_.length&&o<d.length;u++)_[u]===d[o]&&o++;return o===d.length},K=y(()=>g.value?D.value.filter(s=>{var o,u;const e=((o=s.supplier)==null?void 0:o.supplier_name_zh)||s.supplier_id||"",d=((u=s.supplier)==null?void 0:u.supplier_name_en)||"",_=s.supplier_id||"";return N(e,g.value)||N(d,g.value)||N(_,g.value)}):D.value),z=y(()=>p.value.length>0),Y=y(()=>n.value?p.value.length===n.value.items.length:!1),I=y(()=>n.value?n.value.items.filter(s=>p.value.includes(s.detail_id)):[]),A=y(()=>I.value.reduce((s,e)=>s+M(e),0)),G=y(()=>A.value*.05),R=y(()=>Math.round(A.value+G.value)),v=s=>new Intl.NumberFormat("zh-TW",{style:"currency",currency:"TWD",minimumFractionDigits:0}).format(Math.round(s)),J=s=>new Intl.NumberFormat("zh-TW",{style:"currency",currency:"TWD",minimumFractionDigits:1,maximumFractionDigits:1}).format(s),M=s=>Math.round(s.item_quantity*s.unit_price),Z=s=>s.reduce((e,d)=>e+M(d),0),$=()=>{L.push("/purchase-orders")},ee=async()=>{await O()},te=s=>{s?n.value=x.value.find(e=>e.supplier_id===s)||null:n.value=null,p.value=[]},se=s=>{g.value=s},le=()=>{g.value="",S.value=null,n.value=null,p.value=[]},ae=()=>{n.value&&(p.value=n.value.items.map(s=>s.detail_id))},ne=()=>{p.value=[]},O=async()=>{try{T.value=!0;const s=await U.getBuildCandidates(),e=Array.isArray(s)?s:Object.values(s.candidates||s.data||[]);x.value=e.filter(d=>d&&d.items&&d.items.length>0),n.value=null,S.value=null}catch(s){console.error("Failed to load candidates:",s),b.error("載入採購候選項目失敗")}finally{T.value=!1}},ie=async()=>{var s,e,d,_;if(!(!n.value||!z.value)){if(!n.value.supplier_id||n.value.supplier_id==="null"){b.error("無法為此供應商創建採購單：供應商信息不完整");return}try{await me.confirm(`確定要為 ${((s=n.value.supplier)==null?void 0:s.supplier_name_zh)||n.value.supplier_id||"未知供應商"} 建立採購單嗎？
將包含 ${p.value.length} 個項目，總金額 ${v(R.value)}`,"建立採購單確認",{confirmButtonText:"確定建立",cancelButtonText:"取消",type:"warning"}),V.value=!0;const o={supplier_id:n.value.supplier_id,lines:I.value.map(h=>({detail_id:h.detail_id,quantity:h.item_quantity,unit_price:h.unit_price}))},u=await U.createPO(o);b.success("採購單建立成功！"),await O(),p.value=[],L.push("/purchase-orders")}catch(o){if(o!=="cancel")if(console.error("Create PO failed:",o),((e=o.response)==null?void 0:e.status)===400){const u=(d=o.response.data)==null?void 0:d.error,h=u==null?void 0:u.code,P=u==null?void 0:u.message;h==="SUPPLIER_NOT_FOUND"?b.error("供應商不存在，無法建立採購單"):h==="INVALID_REQUISITION_ITEM"?b.error("選擇的項目不可用或已被使用"):b.error(`建立採購單失敗：${P||"未知錯誤"}`)}else((_=o.response)==null?void 0:_.status)===500?b.error("系統內部錯誤，請聯繫管理員"):b.error("建立採購單失敗")}finally{V.value=!1}}};return _e(()=>{O()}),(s,e)=>{const d=Be,_=Ce,o=ve,u=he,h=Ee,P=xe,oe=fe,re=Se,ue=ye,q=be,w=ze,de=Ie;return c(),m("div",Ne,[a(B(Ve),{title:"建立採購單",subtitle:"從已核准請購項目建立採購單","show-back":!0,"show-refresh":!0,onBack:$,onRefresh:ee}),T.value?(c(),m("div",Ae,[a(d,{rows:8,animated:""})])):x.value.length===0?(c(),m("div",Me,[a(u,{description:"暫無可用的請購項目"},{image:i(()=>[a(_,{size:"60"},{default:i(()=>[a(B(we))]),_:1})]),default:i(()=>[a(o,{type:"primary",onClick:$},{default:i(()=>[...e[2]||(e[2]=[k("返回列表",-1)])]),_:1})]),_:1})])):(c(),m("div",Oe,[t("div",Pe,[a(oe,{modelValue:S.value,"onUpdate:modelValue":e[0]||(e[0]=l=>S.value=l),placeholder:"選擇供應商建立採購單（可輸入供應商名稱搜尋）",size:"large",class:"supplier-select",filterable:"",remote:"","remote-method":se,loading:X.value,clearable:"",onChange:te,onClear:le},{default:i(()=>[(c(!0),m(W,null,j(K.value,l=>{var C;return c(),F(P,{key:l.supplier_id,value:l.supplier_id,label:`${((C=l.supplier)==null?void 0:C.supplier_name_zh)||l.supplier_id||"未知供應商"} (${l.items.length}項)`},{default:i(()=>{var E;return[t("div",qe,[t("span",{class:H(["supplier-name",{"urgent-text":l.has_urgent_items}])},[l.has_urgent_items?(c(),F(_,{key:0,color:"#cf1322"},{default:i(()=>[a(B(ge))]),_:1})):Q("",!0),k(" "+r(((E=l.supplier)==null?void 0:E.supplier_name_zh)||l.supplier_id||"未知供應商")+" ",1),l.has_urgent_items?(c(),F(h,{key:1,type:"danger",size:"small",class:"urgent-tag"},{default:i(()=>[...e[3]||(e[3]=[k("加急",-1)])]),_:1})):Q("",!0)],2),t("span",Fe,r(l.items.length)+"項 · "+r(v(Z(l.items))),1)])]}),_:2},1032,["value","label"])}),128))]),_:1},8,["modelValue","loading"])]),n.value?(c(),m("div",De,[t("div",Ge,[t("div",Re,[e[7]||(e[7]=t("h3",null,"待採購項目",-1)),t("div",$e,[a(o,{size:"small",onClick:ae,disabled:Y.value},{default:i(()=>[...e[5]||(e[5]=[k("全選",-1)])]),_:1},8,["disabled"]),a(o,{size:"small",onClick:ne,disabled:!z.value},{default:i(()=>[...e[6]||(e[6]=[k("清空",-1)])]),_:1},8,["disabled"])])]),t("div",Ue,[a(ue,{modelValue:p.value,"onUpdate:modelValue":e[1]||(e[1]=l=>p.value=l)},{default:i(()=>[(c(!0),m(W,null,j(n.value.items,l=>(c(),m("div",{key:l.detail_id,class:H(["item-row",{selected:p.value.includes(l.detail_id)}])},[a(re,{label:l.detail_id,class:"item-checkbox"},{default:i(()=>[t("div",We,[t("div",je,[t("span",He,r(l.item_name),1),t("span",Qe,r(v(l.unit_price)),1)]),t("div",Xe,[t("span",Ke,r(l.item_specification),1),t("span",Ye,r(l.item_quantity)+" "+r(l.item_unit),1)]),t("div",Je,[t("span",Ze,r(l.source_request_order_no),1),t("span",et,"小計: "+r(v(l.item_quantity*l.unit_price)),1)])])]),_:2},1032,["label"])],2))),128))]),_:1},8,["modelValue"])])]),t("div",tt,[t("div",st,[e[9]||(e[9]=t("h3",null,"採購單預覽",-1)),t("div",lt,[a(o,{type:"primary",onClick:ie,disabled:!z.value,loading:V.value},{default:i(()=>[...e[8]||(e[8]=[k(" 建立採購單 ",-1)])]),_:1},8,["disabled","loading"])])]),t("div",at,[z.value?(c(),m("div",it,[a(q,{class:"supplier-info",shadow:"never"},{default:i(()=>{var l,C,E;return[e[13]||(e[13]=t("h4",null,"供應商資訊",-1)),t("div",ot,[t("div",rt,[e[10]||(e[10]=t("label",null,"供應商名稱：",-1)),t("span",null,r(((l=n.value.supplier)==null?void 0:l.supplier_name_zh)||n.value.supplier_id||"未知供應商"),1)]),t("div",ut,[e[11]||(e[11]=t("label",null,"聯絡電話：",-1)),t("span",null,r(((C=n.value.supplier)==null?void 0:C.supplier_phone)||"-"),1)]),t("div",dt,[e[12]||(e[12]=t("label",null,"聯絡人：",-1)),t("span",null,r(((E=n.value.supplier)==null?void 0:E.supplier_contact_person)||"-"),1)])])]}),_:1}),a(q,{class:"items-preview",shadow:"never"},{default:i(()=>[t("h4",null,"採購項目 ("+r(I.value.length)+"項)",1),a(de,{data:I.value,border:"",size:"small"},{default:i(()=>[a(w,{type:"index",label:"序號",width:"50",align:"center"}),a(w,{label:"項目名稱",prop:"item_name","min-width":"120","show-overflow-tooltip":""}),a(w,{label:"規格",prop:"item_specification",width:"100","show-overflow-tooltip":""}),a(w,{label:"數量",prop:"item_quantity",width:"60",align:"center"}),a(w,{label:"單位",prop:"item_unit",width:"60",align:"center"}),a(w,{label:"單價",width:"90",align:"right"},{default:i(({row:l})=>[t("span",ct,r(v(l.unit_price)),1)]),_:1}),a(w,{label:"小計",width:"100",align:"right"},{default:i(({row:l})=>[t("span",pt,r(v(M(l))),1)]),_:1})]),_:1},8,["data"])]),_:1}),a(q,{class:"amount-summary",shadow:"never"},{default:i(()=>[e[17]||(e[17]=t("h4",null,"金額計算",-1)),t("div",_t,[t("div",mt,[e[14]||(e[14]=t("label",null,"項目總計：",-1)),t("span",vt,r(v(A.value)),1)]),t("div",ht,[e[15]||(e[15]=t("label",null,"稅額 (5%)：",-1)),t("span",ft,r(J(G.value)),1)]),t("div",yt,[e[16]||(e[16]=t("label",null,"總金額：",-1)),t("span",bt,r(v(R.value)),1)])])]),_:1})])):(c(),m("div",nt,[a(u,{description:"請選擇要採購的項目"})]))])])])):(c(),m("div",Le,[a(u,{description:"請選擇供應商以查看可採購項目"},{image:i(()=>[a(_,{size:"60"},{default:i(()=>[a(B(ke))]),_:1})]),default:i(()=>[e[4]||(e[4]=t("div",{class:"empty-hint"},[t("p",null,"請從上方下拉選單中選擇一個供應商"),t("p",{class:"hint-secondary"},"選擇後即可查看該供應商的可採購項目")],-1))]),_:1})]))]))])}}});const Qt=Te(wt,[["__scopeId","data-v-e61b6d91"],["__file","D:/AWORKSPACE/Github/project_ERP_dev_agent/frontend/src/views/purchase-orders/BuildCandidates.vue"]]);export{Qt as default};
//# sourceMappingURL=BuildCandidates-78ed2d72.js.map
