import{d as X,n as J,y as Q,r as g,p as h,a1 as Z,c as Y,b as s,t as m,e,w as l,aN as ee,X as c,V as O,m as ae,E as le,o as B,i as y,F as te,s as oe,q as re,g as w,H as se,j as ue,k as ne,aj as de,ah as ie,ai as pe,a4 as _e,au as me,aF as ce,al as ve,av as fe,aw as he,_ as ye}from"./index-61294aba.js";/* empty css                     *//* empty css                        */import"./el-tooltip-4ed993c7.js";/* empty css                     *//* empty css               *//* empty css                *//* empty css                 *//* empty css                        *//* empty css                             *//* empty css                  *//* empty css               *//* empty css                  *//* empty css                       *//* empty css                   */import{f as k}from"./format-8036aac9.js";const Ve={class:"purchase-order-form"},be={class:"page-header"},ge={class:"page-title"},we={class:"actions"},ke={class:"form-container"},Ee={class:"card-header"},Ce={class:"summary"},Ue={class:"summary-item"},qe={class:"summary-item"},xe={class:"summary-item"},Se={class:"total"},De=X({__name:"Form",setup(Oe){const F=J(),E=Q(),I=g(),C=g(!1),U=g([]),v=h(()=>!!F.params.id),M=h(()=>F.params.id),r=g({purchase_order_no:"",supplier_id:null,supplier_name:"",order_date:new Date().toISOString().split("T")[0],quotation_no:"",purchase_status:"order_created",delivery_days:14,remarks:"",items:[]}),$={supplier_id:[{required:!0,message:"請選擇供應商",trigger:"change"}],order_date:[{required:!0,message:"請選擇訂購日期",trigger:"change"}]},V=h(()=>r.value.items.reduce((o,a)=>o+(a.total_price||0),0)),q=h(()=>V.value*.05),P=h(()=>V.value+q.value),N=async()=>{try{const o=await ee.getActiveSuppliers();U.value=o||[]}catch(o){console.error("載入供應商失敗:",o),c.error("載入供應商列表失敗")}},R=async()=>{if(!v.value){const a=new Date().toISOString().slice(0,10).replace(/-/g,""),d=Math.floor(Math.random()*1e3).toString().padStart(3,"0");r.value.purchase_order_no=`PO${a}${d}`;return}try{const o=await O.getPurchaseOrder(M.value);r.value={purchase_order_no:o.purchase_order_no,supplier_id:o.supplier_id,supplier_name:o.supplier_name,order_date:o.order_date,quotation_no:o.quotation_no||"",purchase_status:o.purchase_status,delivery_days:o.delivery_days||14,remarks:o.remarks||"",items:(o.items||[]).map(a=>({material_no:a.material_no||"",description:a.item_name||"",unit:a.item_unit||"個",quantity:a.item_quantity||1,unit_price:a.unit_price||0,total_price:(a.item_quantity||1)*(a.unit_price||0)}))}}catch(o){console.error("載入採購單資料失敗:",o),c.error("載入採購單資料失敗"),E.push("/purchase-orders")}},T=o=>{const a=U.value.find(d=>d.id===o);a&&(r.value.supplier_name=a.name)},A=()=>{r.value.items.push({material_no:"",description:"",unit:"個",quantity:1,unit_price:0,total_price:0})},z=o=>{o.total_price=(o.quantity||0)*(o.unit_price||0)},j=async()=>{try{if(!await I.value.validate())return;if(r.value.items.length===0){c.warning("請至少新增一個採購項目");return}C.value=!0;const a={...r.value,subtotal_int:V.value,tax_int:q.value,grand_total_int:P.value};if(v.value)await O.updatePurchaseOrder(M.value,a),c.success("採購單更新成功");else{const d=await O.createPurchaseOrder(a);c.success("採購單建立成功"),E.push(`/purchase-orders/${d.purchase_order_no}`)}}catch(o){console.error("儲存採購單失敗:",o),c.error(v.value?"更新採購單失敗":"建立採購單失敗")}finally{C.value=!1}},G=o=>{se.confirm("確定要刪除此項目？","提示",{confirmButtonText:"確定",cancelButtonText:"取消",type:"warning"}).then(()=>{r.value.items.splice(o,1)}).catch(()=>{})},H=()=>{E.back()};return Z(()=>{N(),R()}),(o,a)=>{const d=ae,f=ue,_=ne,i=de,n=ie,x=pe,b=_e,K=me,S=ce,D=ve,p=fe,L=he,W=le;return B(),Y("div",Ve,[s("div",be,[s("h1",ge,m(v.value?"編輯採購單":"新增採購單"),1),s("div",we,[e(d,{onClick:H},{default:l(()=>[...a[7]||(a[7]=[y("返回",-1)])]),_:1}),e(d,{type:"primary",onClick:j,loading:C.value},{default:l(()=>[y(m(v.value?"更新":"儲存"),1)]),_:1},8,["loading"])])]),s("div",ke,[e(W,{model:r.value,rules:$,ref_key:"formRef",ref:I,"label-width":"120px"},{default:l(()=>[e(D,{class:"form-card"},{header:l(()=>[...a[8]||(a[8]=[s("h3",null,"基本資訊",-1)])]),default:l(()=>[e(b,{gutter:20},{default:l(()=>[e(i,{span:12},{default:l(()=>[e(_,{label:"採購單號",prop:"purchase_order_no"},{default:l(()=>[e(f,{modelValue:r.value.purchase_order_no,"onUpdate:modelValue":a[0]||(a[0]=t=>r.value.purchase_order_no=t),disabled:""},null,8,["modelValue"])]),_:1})]),_:1}),e(i,{span:12},{default:l(()=>[e(_,{label:"供應商",prop:"supplier_id"},{default:l(()=>[e(x,{modelValue:r.value.supplier_id,"onUpdate:modelValue":a[1]||(a[1]=t=>r.value.supplier_id=t),placeholder:"選擇供應商",style:{width:"100%"},onChange:T},{default:l(()=>[(B(!0),Y(te,null,oe(U.value,t=>(B(),re(n,{key:t.supplier_id,label:`${t.supplier_id} - ${t.supplier_name_zh}`,value:t.supplier_id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}),e(b,{gutter:20},{default:l(()=>[e(i,{span:12},{default:l(()=>[e(_,{label:"訂購日期",prop:"order_date"},{default:l(()=>[e(K,{modelValue:r.value.order_date,"onUpdate:modelValue":a[2]||(a[2]=t=>r.value.order_date=t),type:"date",placeholder:"選擇日期",format:"YYYY/MM/DD","value-format":"YYYY-MM-DD",style:{width:"100%"}},null,8,["modelValue"])]),_:1})]),_:1}),e(i,{span:12},{default:l(()=>[e(_,{label:"報價單號",prop:"quotation_no"},{default:l(()=>[e(f,{modelValue:r.value.quotation_no,"onUpdate:modelValue":a[3]||(a[3]=t=>r.value.quotation_no=t),placeholder:"請輸入報價單號"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),e(b,{gutter:20},{default:l(()=>[e(i,{span:12},{default:l(()=>[e(_,{label:"交貨天數",prop:"delivery_days"},{default:l(()=>[e(S,{modelValue:r.value.delivery_days,"onUpdate:modelValue":a[4]||(a[4]=t=>r.value.delivery_days=t),min:1,max:365,placeholder:"請輸入交貨天數",style:{width:"100%"}},null,8,["modelValue"])]),_:1})]),_:1}),e(i,{span:12},{default:l(()=>[e(_,{label:"採購狀態",prop:"purchase_status"},{default:l(()=>[e(x,{modelValue:r.value.purchase_status,"onUpdate:modelValue":a[5]||(a[5]=t=>r.value.purchase_status=t),placeholder:"請選擇狀態",style:{width:"100%"}},{default:l(()=>[e(n,{label:"已建立",value:"order_created"}),e(n,{label:"已製單",value:"outputted"}),e(n,{label:"已採購",value:"purchased"}),e(n,{label:"已發貨",value:"shipped"})]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}),e(_,{label:"備註"},{default:l(()=>[e(f,{modelValue:r.value.remarks,"onUpdate:modelValue":a[6]||(a[6]=t=>r.value.remarks=t),type:"textarea",rows:3,placeholder:"請輸入備註"},null,8,["modelValue"])]),_:1})]),_:1}),e(D,{class:"form-card"},{header:l(()=>[s("div",Ee,[a[10]||(a[10]=s("h3",null,"採購項目",-1)),e(d,{type:"primary",size:"small",onClick:A},{default:l(()=>[...a[9]||(a[9]=[y(" 新增項目 ",-1)])]),_:1})])]),default:l(()=>[e(L,{data:r.value.items,stripe:""},{default:l(()=>[e(p,{type:"index",label:"項次",width:"60"}),e(p,{label:"物料編號",width:"120"},{default:l(({row:t})=>[e(f,{modelValue:t.material_no,"onUpdate:modelValue":u=>t.material_no=u,size:"small"},null,8,["modelValue","onUpdate:modelValue"])]),_:1}),e(p,{label:"品名規格","min-width":"200"},{default:l(({row:t})=>[e(f,{modelValue:t.description,"onUpdate:modelValue":u=>t.description=u,size:"small"},null,8,["modelValue","onUpdate:modelValue"])]),_:1}),e(p,{label:"單位",width:"100"},{default:l(({row:t})=>[e(x,{modelValue:t.unit,"onUpdate:modelValue":u=>t.unit=u,size:"small"},{default:l(()=>[e(n,{label:"個",value:"個"}),e(n,{label:"件",value:"件"}),e(n,{label:"箱",value:"箱"}),e(n,{label:"台",value:"台"}),e(n,{label:"組",value:"組"}),e(n,{label:"批",value:"批"})]),_:1},8,["modelValue","onUpdate:modelValue"])]),_:1}),e(p,{label:"數量",width:"100"},{default:l(({row:t})=>[e(S,{modelValue:t.quantity,"onUpdate:modelValue":u=>t.quantity=u,size:"small",min:1,onChange:u=>z(t)},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:1}),e(p,{label:"單價",width:"120"},{default:l(({row:t})=>[e(S,{modelValue:t.unit_price,"onUpdate:modelValue":u=>t.unit_price=u,size:"small",min:0,precision:2,onChange:u=>z(t)},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:1}),e(p,{label:"小計",width:"120"},{default:l(({row:t})=>[y(m(w(k)(t.total_price||0)),1)]),_:1}),e(p,{label:"操作",width:"80",fixed:"right"},{default:l(({$index:t})=>[e(d,{size:"small",type:"danger",onClick:u=>G(t)},{default:l(()=>[...a[11]||(a[11]=[y(" 刪除 ",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])]),_:1}),e(D,{class:"form-card"},{header:l(()=>[...a[12]||(a[12]=[s("h3",null,"金額總計",-1)])]),default:l(()=>[s("div",Ce,[e(b,{gutter:20},{default:l(()=>[e(i,{span:8},{default:l(()=>[s("div",Ue,[a[13]||(a[13]=s("label",null,"小計：",-1)),s("span",null,m(w(k)(V.value)),1)])]),_:1}),e(i,{span:8},{default:l(()=>[s("div",qe,[a[14]||(a[14]=s("label",null,"稅額：",-1)),s("span",null,m(w(k)(q.value)),1)])]),_:1}),e(i,{span:8},{default:l(()=>[s("div",xe,[a[15]||(a[15]=s("label",null,"總計：",-1)),s("span",Se,m(w(k)(P.value)),1)])]),_:1})]),_:1})])]),_:1})]),_:1},8,["model"])])])}}});const Le=ye(De,[["__scopeId","data-v-759f60c3"],["__file","D:/AWORKSPACE/Github/project_ERP_dev_agent/frontend/src/views/purchase-orders/Form.vue"]]);export{Le as default};
//# sourceMappingURL=Form-c98a423c.js.map
