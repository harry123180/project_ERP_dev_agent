# 模型設計.md（完整）

## 目標

用最少且職責明確的模型，支撐「請購 → 採購 → 交期維護 → 收貨 → 入庫 ↔ 驗收 → 領用 → 會計請款/付款」；把商業規則集中在模型層，降低控制器/前端複雜度。

---

## 1) Requisition（請購聚合根）

**做什麼**：請購單頭與明細的建立、送審、逐行裁決。

**表**：`Request_Order`、`Request_Order_Item`、`RequisitionLineHistory`

**方法**：`add_line`、`remove_line`、`submit`、`line_approve`、`line_question`、`line_reject`、`line_unavailable`、`reject_order`、`maybe_close_review`

## 2) RequisitionLine（請購單身）

**做什麼**：單一請購行的狀態與校驗。

**表**：`Request_Order_Item`

**方法**：`approve`、`question`、`reject`、`mark_unavailable`

## 3) RequisitionLineHistory（請購歷程）

**做什麼**：請購行狀態變更與理由的審計。

**表**：`RequisitionLineHistory`（或你的 `RequestItemHistory/Audit`）

**方法**：`append`、`list`

## 4) SupplierDirectory（供應商主檔）

**做什麼**：供應商維護與查詢。

**表**：`Supplier`

**方法**：`upsert`、`get`、`list_by_region`

## 5) ItemCatalog（物品主檔/類別）

**做什麼**：品項與類別維護（交易單快照名稱/規格/型號）。

**表**：`ItemCategory`、（你的）`ItemMaster`

**方法**：`get_item`、`list_by_category`、`get_category`、`list_categories`

## 6) ItemSupplierPrice（價目/價格歷史）

**做什麼**：供應商×物品的有效價格區間。

**表**：`Item_Supplier_Price`（或你的 `ItemSupplierPrice/PriceHistory`）

**方法**：`set_price`（效期不重疊檢核）／`get_active_price`

## 7) PurchaseOrder（採購聚合根）

**做什麼**：把已核准請購行依供應商組成採購單；金額計算；確認採購。

**表**：`Purchase_Order`、`Purchase_Order_Item`

**方法**：`create_from_requisition_lines`、`add_line`、`remove_line`、`recalculate_totals`、`save_draft`、`confirm_purchase`、`withdraw`、`reorganize`

**欄位補充（已提過）**：`subtotal_int`、`tax_decimal1`、`grand_total_int`、`shipping_status` 等。

## 8) PurchaseOrderLine（採購單身）

**做什麼**：行層級金額/狀態封裝。

**表**：`Purchase_Order_Item`

**方法**：`compute_subtotal_int`、`mark_purchased/mark_shipped/mark_arrived`

## 9) LeadtimeTracker（交期維護）

**做什麼**：已採購後之里程碑/物流；可含集運倉。

**表**：`Purchase_Order`、（可選）`Shipment_Consolidation`、`Consolidation_PO`、`Logistics_Event`

**方法**：`update_milestone`、`create_consolidation`、`add_po/remove_po`、`bulk_update`、`append_event`

## 10) LogisticsEventStream（交期事件流）

**做什麼**：PO/集運倉的交期事件。

**表**：`Logistics_Event`

**方法**：`append`、`list_for_po`、`list_for_consolidation`

---

## 11) ReceivingManager（收貨管理）

**做什麼**

誰在場誰收貨；依國內/國外與供應商查看未到貨 PO，逐項確認到貨；記錄收貨人與時間，將項目轉入「待入庫」。

**管理的表**

- 來源：`Purchase_Order`、`Purchase_Order_Item`（僅列出尚未到貨的行）
- 記錄：`User_Purchase_History`（可選用以記錄確認到貨/簽收人）
- （可選）新增 `Receiving_Record`（建議）：`po_no`, `detail_id`, `received_by`, `received_at`, `qty_received`（若支援部分到貨）

**方法**

- `list_pending(supplier_id, region, month?)`：依國內/國外＋供應商列出未到貨 PO。
- `open_po(po_no)`：顯示該 PO 明細供逐項核對。
- `confirm_item_received(po_no, detail_id, received_by, received_at)`：
    - 記錄收貨人與時間；
    - 更新 PO 行/單頭狀態到「已到貨」（或由交期維護同步）；
    - 將該行加入「待入庫列表」。

**為什麼需要**

把「誰收、何時收」落在一個模型，讓交期頁面與倉儲頁能接軌。

---

## 12) PutawayService（入庫／儲位分配）

**做什麼**

將已到貨的 Item 分配儲位，並寫入庫存移轉「入庫」紀錄；更新狀態為已入庫。

**管理的表**

- `Storage`（儲位主檔）
- `Storage_History`（作為庫存移轉帳／movement ledger；`operation_type='in'`）
- （來源）`Purchase_Order_Item`（對應到貨項）

**方法**

- `assign_location(item_id or po_no+detail_id, area, shelf, floor, front_back, lmr)`：回寫 `storage_location_code`。
- `stock_in(item_id or po_no+detail_id, quantity, storage_id, operator_id, source='PO', when)`：寫一筆 `Storage_History`。
- `mark_warehoused(item_ref)`：將項目狀態改為「已入庫」。

**為什麼需要**

把位置分配與入庫行為封裝，確保庫存與狀態一致。

---

## 13) AcceptanceService（驗收）

**做什麼**

請購人於「我的請購」頁對已到貨/已入庫項目做驗收；記錄驗收人與日期；允許「收貨→入庫→驗收」或「收貨→驗收→入庫」順序。

**管理的表**

- `Request_Order_Item`（`acceptance_status`）
- `User_Acceptance_History`（寫入驗收記錄）

**方法**

- `list_pending_by_requester(user_id)`：請購人待驗收清單。
- `accept(item_ref, accepted_by, acceptance_date)`：
    - 更新 `acceptance_status='accepted'`；
    - 寫 `User_Acceptance_History`。

**為什麼需要**

將驗收權責回到請購人，並保留可追溯紀錄。

---

## 14) StorageAdmin（儲位結構管理）

**做什麼**

維護區域/架子/層數/前後/左右中結構與命名。

**管理的表**

- `Storage`

**方法**

- `create_zone(area_code, area_name)`／`update_zone`／`delete_zone`
- `create_shelf(area_code, shelf_code, shelf_name, floors=6)`／`update_shelf`／`delete_shelf`
- `set_floor_count(area_code, shelf_code, floors)`
    
    -（必要時）批次生成某區域的所有層×前後×左右中。
    

**為什麼需要**

讓入庫與查詢頁能可靠地依結構篩選。

---

## 15) InventoryQuery & IssueService（庫存查詢與領用出庫）

**做什麼**

依多條件（品名/規格模糊、請購單號、PO 單號、用途、位置路由）查庫存；支援分位置顯示；可直接領用出庫，記錄使用者、時間、數量。

**管理的表**

- 查詢：彙總自 `Storage_History`（in-out 聚合；或用 VIEW/物化視圖）
- 出庫：`Storage_History`（`operation_type='out'`）、`User_Issue_History`

**方法**

- `search(filter)`：支援
    - 品名/規格模糊、請購單號、PO 單號、用途（日常/專案）、位置路由（Zone/Shelf/Floor…）。
- `issue(item_ref, storage_id, qty, issued_by, issued_at)`：
    - 寫 `Storage_History(out)`；
    - 寫 `User_Issue_History`（**使用者、時間、領用數量**）；
    - 檢核：`qty` 為正整數且不得超過該位置可用量。

**為什麼需要**

把查庫存與扣帳封裝，保證每次領用都有審計足跡。

---

## 16) BillingManager & PaymentManager（會計：請款與付款）

**做什麼**

依供應商與月份、帳期（30/60天）挑出「未付款」的 PO，彙總金額，輸出**請款單**與**支票付款回簽聯**；之後標記「已付款」。支援「單張先付款」。

**管理的表**

- 來源：`Purchase_Order`（需有或新增）
    - 建議加：`billing_status ENUM('none','billed','paid')`、`payment_method ENUM('remittance','check','cash')`（可 NULL）、`due_date DATE`、`billed_month CHAR(7)`（YYYY-MM）
        
        -（建議新增，方便留檔與多次請款）
        
    - `AP_Billing`（請款批次：supplier_id, month, term, subtotal_int, tax_decimal1, grand_total_int, discount, other_deduction, invoice_or_receipt, billed_amount, due_date, created_by, created_at）
    - `AP_Billing_PO`（對應到本批次的 PO 清單：po_no, amount_in_batch）
    - `AP_Payment`（實際付款紀錄：supplier_id, pay_date, method, amount, ref_billing_id?）

**方法**

- 查詢/對帳
    - `list_unpaid_po(supplier_id, month)`：依 **30/60天**規則回傳期間內「未付款」PO；套用**25 號結帳**（1–25 算當月，26–月底算次月）。
    - `summarize(po_list)`：計算總未稅/稅額/含稅。
- 生成請款
    - `generate_billing(supplier_id, month, term, opts)`：帶入供應商、月份、付款條件與金額彙總；可填 **進貨折讓**、**其他扣款**、**發票/收據**；計算 **開票金額 = 總金額 − 折讓 − 扣款**；
    - 同步建立**支票付款回簽聯**資料（銀行固定、到期日＝月底+帳期、支票號碼留空）。
    - 更新被納入的 PO：`billing_status='billed'`、回寫 `due_date`、`billed_month`。
- 付款
    - `mark_paid_by_batch(billing_id, method, pay_date)`：把此批次所有 PO → `billing_status='paid'`、`payment_method=method`。
    - `mark_paid_by_po(po_no, method, pay_date)`（**單張先付款**）：單筆 PO 直接 `paid`；之後不會再被列入任一批次。

**為什麼需要**

把月份/帳期/結帳日邏輯與文件輸出、狀態變更集中管理；避免重複請款與遺漏付款。

---

## 關鍵商業規則（統一由模型層執行）

- **數量/金額**：與先前規則一致（行小計整數、稅額一位小數、含稅整數）。
- **交期維護頁**：只顯示 `purchase_status='purchased'` 且 `shipping_status<>'arrived'`。
- **收貨**：記錄收貨人、時間；項目轉入待入庫。
- **入庫**：分配儲位（Zone/Shelf/Floor/FrontBack/LMR），寫 `Storage_History(in)`，狀態→已入庫。
- **驗收**：請購人操作；寫 `User_Acceptance_History`，`acceptance_status='accepted'`。
- **領用**：寫 `Storage_History(out)` ＋ `User_Issue_History(含領用數量)`；不得負庫存。
- **請款查詢**：只列**未付款**的 PO；
    - **30 天**：抓「所選月份」；
    - **60 天**：抓「所選月份 + 上個月」；
    - **結帳日 25 號**規則影響月份歸屬。
- **請款輸出**：被納入的 PO → `billing_status='billed'`；產生回簽聯（到期日＝月底＋帳期；支票號碼留空）。
- **付款**：批次或單張 → `billing_status='paid'`，並記錄 `payment_method`；已付款的 PO 不再出現在請款查詢。

---

這份就是**全流程的模型清單**。

如果你要下一步實作，我可以把 11–16 的 **SQL/欄位最小增補**（CREATE/ALTER），以及 **服務層介面（Python/SQLAlchemy 樣板）**生出來，直接接到你現有專案。